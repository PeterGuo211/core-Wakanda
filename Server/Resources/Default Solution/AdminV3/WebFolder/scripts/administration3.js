/*Wakanda Software (the "Software") and the corresponding source code remainthe exclusive property of 4D and/or its licensors and are protected by nationaland/or international legislations.This file is part of the source code of the Software provided under the relevantWakanda License Agreement available on http://www.wakanda.org/license whose complianceconstitutes a prerequisite to any use of this file and more generally of theSoftware and the corresponding source code.*/function firstToUpper(str) {    return str.replace(/^(.)(.*)/, function(str, p1, p2) {        return p1.toUpperCase() + p2;    })}if (typeof WAF === 'undefined') {    WAF = {};  //object vide}WAF.serverAdmin = {  // Sous objet    status:		null, // attribut    rpc:		null,    loader:		{        show:	function() {  //attribut (methode)            $('#test').show();        },        hide:	function() {            $('#test').hide();        }    },    dialog:		{        show:	function() {            $('#administration-workspace-left-content').show();        },        hide:	function() {            $('#administration-workspace-left-content').hide();        }    },    console:	{ //sous sous objet        timer:			null,        opened:			false,        node:			$('#wafConsole'),        getServerLog:	function() {            try {                var result = getLogMessages();                                this.log(result.messages, true);            } catch(E) {                this.log('<b>getServerLog failed :</b> ' + E);            };        },        log:			function(el, open) {            var html = '';			            if($.isArray(el) && el.length) {                html = el.join('<br />') + '<br />';            } else if ($.isPlainObject(el) && el.message && (el.message !== '')) {                html = el.message.bold() + ' : ' + el.description + '<br />';            } else if (el.toString() !== '') {                html = el.toString() + '<br />';            }			            if(html !== '') {                if(open) this.open();                $('#wafConsole .content').append(html).scrollTop($('#wafConsole .content').height() + 100);            }        },        open:			function() {            if(!this.opened) {                this.node                .animate({                    height: '20%'                })                /*					.animate(						{height: '20%'},						500,						function() {							console.log(this)						}					)*/                .addClass('visible');                this.opened = true;            }        },        close:			function() {            if(this.opened) {                this.node                .animate({                    height: 27                })                .removeClass('visible');                this.opened	= false;            }        },        toggle:			function() {            (this.opened) ? this.close() : this.open();        }    },    solution:	{        openTimer:	null,        current:	null,        open:		null,        recent:		{            name:	'',            path:	''        },        openRecent:	null,        get:		null,        close:		null,                loadBy:		function(type) {            var n = 0;            this.openTimer = setInterval(function() {  //this referebce d'objt loadBy'                if(n < 10) {                    try {                        tmpSolution = WAF.serverAdmin.solution.get();                        if(typeof(tmpSolution) === 'object' && typeof(tmpSolution['name']) !== 'undefined') {                            WAF.serverAdmin.solution.current	= tmpSolution;                            WAF.serverAdmin.solutions.recent	= WAF.serverAdmin.solutions.getRecent();                            WAF.serverAdmin.solutions.setRecent();                            WAF.serverAdmin.console.getServerLog();                            WAF.serverAdmin.solution.build(WAF.serverAdmin.solution.current);							                            clearInterval(WAF.serverAdmin.solution.openTimer);							                            WAF.serverAdmin.loader.hide();                        }                    } catch(E) {                    //WAF.serverAdmin.console.log(E);                    }                } else {                    clearInterval(WAF.serverAdmin.solution.openTimer);                    switch(type) {                        case 'name':                            WAF.serverAdmin.solution.openRecent(WAF.serverAdmin.solution.recent.name);                            break;                        case 'path':                            WAF.serverAdmin.solution.open(WAF.serverAdmin.solution.recent.path);                            break;                    }                }                n++;            }, 3000);                 },        build:		function(solution) {            // Setting solution's name            $('#solution-identity h1').text(solution.name);			          $('#viewport').empty();						// Building applications			$(solution.projects).each(function(i, application) {				// We dont show admin solution				if(application.admin) return;								// Extending application with some properties				application.number = i;				application.id = 'application-' + application.number;				application.template = template3;								$('#viewport').append(application.template.replace(/__(.*?)__/ig, function(str, object) {					return (eval(object) !== undefined) ? eval(object) : '';				}));			});						WAF.serverAdmin.loader.hide();						            WAF.serverAdmin.loader.hide();        }    },    solutions:	{        recent:	null,        getRecent:	null,        setRecent:	function() {                                   $('.solutions').empty();                        $(window.glo.solutions).each(function(i, sol ) {                                var element;                //------------------solutions                        if (WAF.serverAdmin.solution.current.name== sol.name){                             element = '<div id ="sol" class="solution solution_selected" ><span>' + sol.name + '</span></div>';                        }else{                            element = '<div id ="sol" class="solution" ><span>' + sol.name + '</span></div>';                                                    }                                $('.solutions').append(element);                                                                                  });               //---------------------------                                                                                }    },    init:		function() {        this.rpc = new WAF.classes.Rpc();    	        // Mapping of interfacing functions        this.rpc.getInterfaces();    	        this.solution.close			= closeSolution;        this.solution.get			= getSolution;        this.solution.open			= openSolution;        this.solution.openRecent	= openRecentSolution;           	window.glo = getSolutions();                       this.solutions.getRecent	= getRecentSolutions;    	    	        // Building default solution        this.solution.current		= this.solution.get();        if(typeof(this.solution.current) === 'undefined') this.console.log('Unable to retrieve a solution.', true);    	        this.solutions.recent		= this.solutions.getRecent();        this.solutions.setRecent();    	//        this.console.getServerLog();            	        this.solution.build(window.glo.solutions[0]);                    }};( function(){        //specific mod for tests purpose in the navigator (see web toolbar)                ( typeof( studio ) === "undefined" ) ? $('#container').css("height","1022px") : $('#container').css("height","920px") ;           WAF.serverAdmin.init();        $("#administration-toolbar").show();                     // EVENT DELEGATION *******************************************************	$(document.body)          .delegate('.application', {        	click : function(event){				$('.application').removeClass('selected');				$(this).addClass('selected');								 var name_sol = $('.solution_selected').find('span').html();				 var name_app = $(this).find('.head h2').html();				 var sol_selected = $('.solution-click').find('span').html();				  				 loadfileslog(name_app);			 },			 mouseenter : function(event) {				$(this).addClass('hover');			 },			 mouseleave : function(event) {				$(this).removeClass('hover');			 }		})        .delegate('.toolbar-element.toolbar-button.administration-verify', 'click', function(event) {                            if($('.application.selected').find('.head h2').html()!=null) {            var name_app,Url;                                                          var name_sol = $('.solution_selected').find('span').html();                         var name_app = $('.application.selected').find('.head h2').html();                         var sol_selected = $('.solution-click').find('span').html();                                                  var sol ;                         if (sol_selected == null){                             sol = name_sol;                         }else{                                                       sol  = sol_selected;                           }                                                                                                                                           var App = {                                 name : name_app ,                                 sol_name : sol                             };							                                                       App = JSON.stringify(App);                             Url =  '/Verify';                             $.ajax({                                    type: 'POST',                                    url         :   Url,                                    data        :   App,                                    contentType :   "text/plain",                                    async  : false,                                    success:function(data){                                        var response = JSON.parse(data);                                        var name_app =   JSON.parse(App);                                         appendFileToLogs(name_app.name, getsolution_byname(name_app.sol_name), response.file)                                         var  tables=response.errors;										 var txt='' ;										 txt = '<p style="font-family:Arial,sans-serif; font-size:18px; color:green" > Name of project : ' + name_app.name +' /Verify</p>';                                         if (tables.length> 0 ){                                                             for (var i=0;i<tables.length;i++){															                                                       if (tables[i].ErrorText) {                                                                                                       txt += '<p style="font-family:Arial,sans-serif; font-size:18px; color:Red">Error : ' + tables[i].ErrorText + ' ,ProblemType :' + tables[i].ProblemType+                                                            ', ErrorNumber : ' + tables[i].ErrorNumber +' ,ProblemTypeText :' + tables[i].ProblemTypeText + ' ,ErrorLevel :' + tables[i].ErrorLevel;															if (tables[i].RecordNum){															     txt += ' ,RecordNum :' + tables[i].RecordNum + '</p>' ;															}else{															txt +='</p>';																														}																																																								                                                        }else{                                                           txt +='<p style="font-family:Arial,sans-serif; font-size:18px; color:blue">' + tables[i]+ '</p>' ;                                                           }                                                            }                                                                                                     } else {                                                                                           txt += '<p style="font-family:Arial,sans-serif; font-size:18px; color:blue" > no errors found </p>';                                                                                      }                                        $('#wafConsole .content').prepend(txt);                                       //                                        var //                                        portlet = $('.portlet-content'),//                                        fileDiv = $('<div class = "file">'),//                                        fileSpanName = $('<span style="margin-right:40px;">').append($('<a onclick = "OpenStudio(\'' + response.file.path + '\'" href = "#" style = "text-decoration:none;">').html('verify')),//                                        fileSpanDate = $('<span style = "margin-right:40px;">' + response.file.date + '</span>'),//                                        fileBtnRemove = $('<button class="studio-icon-remove" value="' + response.file.name + '" style="display: none;"></button>'),//                                        fileSpanRemove= $('<span>').addClass('tdcol').append(fileBtnRemove);//                                        //                                        fileDiv.append(fileSpanName);//                                        fileDiv.append(fileSpanDate);//                                        fileDiv.append(fileSpanRemove);//                                        //                                        portlet.append(fileDiv);                                        loadfileslog(name_app.name);                                        },                                        error :function(err) {                                        }                                       });//        loadfiles(name_app,sol);                                                                     							                                                      }else{                              alert("Please choose a project")           }                                       })       .delegate('.toolbar-element.toolbar-button.administration-repair', 'click', function(event) {                       if($('.application.selected').find('.head h2').html()!=null){                             var name_app,Url;                                           var name_sol = $('.solution_selected').find('span').html();                         var name_app = $('.application.selected').find('.head h2').html();                         var sol_selected = $('.solution-click').find('span').html();                                                  var sol ;                         if (sol_selected == null){                             sol = name_sol;                         }else{                                                       sol  = sol_selected;                           }                                                                      name_app = $('.application.selected').find('.head h2').html();                                                          var App = {                                 name : name_app,                                 sol_name : sol                                                              };							                                                       App = JSON.stringify(App);                             Url =  '/Repair';                             $.ajax({                                    type: 'POST',                                    url         :   Url,                                    data        :   App,                                    contentType :   "text/plain",                                    async  : false,                                    success:function(data){                                       var response = JSON.parse(data);                                        var name_app =   JSON.parse(App);                                         appendFileToLogs(name_app.name, getsolution_byname(name_app.sol_name), response.file)                                         var  tables=response.errors;										 var txt='' ;										 txt = '<p style="font-family:Arial,sans-serif; font-size:18px; color:green" > Name of project : ' + name_app.name +' /Repair</p>';                                         if (tables.length> 0 ){                                                             for (var i=0;i<tables.length;i++){															                                                       if (tables[i].ErrorText) {                                                                                                       txt += '<p style="font-family:Arial,sans-serif; font-size:18px; color:Red">Error : ' + tables[i].ErrorText + ' ,ProblemType :' + tables[i].ProblemType+                                                            ', ErrorNumber : ' + tables[i].ErrorNumber +' ,ProblemTypeText :' + tables[i].ProblemTypeText + ' ,ErrorLevel :' + tables[i].ErrorLevel;															if (tables[i].RecordNum){															     txt += ' ,RecordNum :' + tables[i].RecordNum + '</p>' ;															}else{															txt +='</p>';																														}																																																								                                                        }else{                                                           txt +='<p style="font-family:Arial,sans-serif; font-size:18px; color:blue">' + tables[i]+ '</p>' ;                                                           }                                                            }                                                                                                     } else {                                                                                           txt += '<p style="font-family:Arial,sans-serif; font-size:18px; color:blue" > no errors found </p>';                                                                                      }                                        $('#wafConsole .content').prepend(txt);                                                                             	loadfileslog(name_app.name);                                         },                                        error :function(err) {                                        }                                       });                                                 									                                                                      }else{                              alert("Please choose a project")           }                                       })       .delegate('.toolbar-element.toolbar-button.administration-compact', 'click', function(event) {                              if($('.application.selected').find('.head h2').html()!=null){                         var name_app,Url;                         var name_sol = $('.solution_selected').find('span').html();                          name_app = $('.application.selected').find('.head h2').html();                         var sol_selected = $('.solution-click').find('span').html();                                                  var sol ;                         if (sol_selected == null){                             sol = name_sol;                         }else{                                                       sol  = sol_selected;                           }                                                          var App = {                                 name : name_app,                                 sol_name: sol                             };			                        App = JSON.stringify(App);                             Url =  '/Compact';                             $.ajax({                                    type: 'POST',                                    url         :   Url,                                    data        :   App,                                    contentType :   "text/plain",                                    async  : false,                                    success:function(data){                                         var response = JSON.parse(data);                                        var name_app =   JSON.parse(App);                                         appendFileToLogs(name_app.name, getsolution_byname(name_app.sol_name), response.file)                                         var  tables=response.errors;										 var txt='' ;										 txt = '<p style="font-family:Arial,sans-serif; font-size:18px; color:green" > Name of project : ' + name_app.name +' /Compact</p>';                                         if (response.length> 0 ){                                                             for (var i=0;i<tables.length;i++){															                                                       if (tables[i].ErrorText) {                                                                                                       txt += '<p style="font-family:Arial,sans-serif; font-size:18px; color:Red">Error : ' + tables[i].ErrorText + ' ,ProblemType :' + tables[i].ProblemType+                                                            ', ErrorNumber : ' + tables[i].ErrorNumber +' ,ProblemTypeText :' + tables[i].ProblemTypeText + ' ,ErrorLevel :' + tables[i].ErrorLevel;															if (tables[i].RecordNum){															     txt += ' ,RecordNum :' + tables[i].RecordNum + '</p>' ;															}else{															txt +='</p>';																														}																																																								                                                        }else{                                                           txt +='<p style="font-family:Arial,sans-serif; font-size:18px; color:blue">' + tables[i]+ '</p>' ;                                                           }                                                            }                                                                                                    } else {                                                                                           txt += '<p style="font-family:Arial,sans-serif; font-size:18px; color:blue" > no errors found </p>';                                                                                      }                                        $('#wafConsole .content').prepend(txt);                                      	loadfileslog(name_app.name);                                          },                                        error :function(err) {                                        }                                       });                                                     }else{                              alert("Please choose a project")           }                   })              .delegate('#remove', 'click', function(event) {                                         var name_sol = $('.solution_selected').find('span').html();                                                 var sol_selected = $('.solution-click').find('span').html();                                                  var sol ;                         if (sol_selected == null){                             sol = name_sol;                         }else{                                                       sol  = sol_selected;                           }                                                                var file = {                                 name : $(this).val(),                                 sol_name : sol                             };                                                     file = JSON.stringify(file);                              Url =  '/DeleteFile';                             $.ajax({                                    type: 'POST',                                    url         :   Url,                                    data        :   file,                                    async  : false,                                    contentType :   "text/plain",                                    success:function(data){                                                                          },                                    error :function(err) {                                        }                                       });                                                        var name_app = $('.content_selected').find('h2').html();                                               file = JSON.parse(file);                         removeFileToLogs(name_app, getsolution_byname(file.sol_name), file.name)                           loadfileslog(name_app);                             	})                                   .delegate('#sol', 'click', function(event) {                               		var name = $('.solution-click').find('span').html();                                  var   solution   = getsolution_byname(name)                      WAF.serverAdmin.solution.build(solution);                                         	})                  } )();function loadfileslog(name_app){                 $(".administration-content").empty();                                                   var name_sol = $('.solution_selected').find('span').html();                                                var sol_selected = $('.solution-click').find('span').html();                                                  var sol ;                         if (sol_selected == null){                             sol = name_sol;                         }else{                                                       sol  = sol_selected;                           }                                                  var                          solution   = getsolution_byname(sol),                         App        = getApplicationFromSol(name_app, solution);                                                                                                               var  tables=App.logFiles;                                                                                var txt="";                                         var regName=new RegExp("[ ]+", "g");                                          var regDate=new RegExp("[T]+", "g");                                        for (var i=0;i<tables.length;i++){                                                                                     var  name = tables[i].name.split(regName)                                          var  date = tables[i].date.split(regDate)                                                                                      txt+=   '<div class = "file"><span style="margin-right:40px;"><a style="text-decoration:none;" href="#" onClick="OpenStudio(\''+tables[i].path+'\')" >'+name[0]+'</a></span><span style="margin-right:40px;" >'+date[0]+' '+date[1].substring(0, 5)+'</span><span class="tdcol"><button id="remove"  class="studio-icon-remove" value="'+tables[i].name+'"></button></span></div>';                                                                                     }                                                                                                                        txt = '<div class="portlet-content">'+txt+'</div>';                                                                                                                                                                     $(".administration-content").append(txt);                                                                                   tabledroite();    }function getsolution_byname(name){    var res;        $(window.glo.solutions).each(function(key, sol){        if(sol.name == name){            res = sol;            return res;        }    })        return res;                }/** * @param {String} appname : le nom du projet * @param {Object} sol : l'objet solution * @return {Object} le projet */function getApplicationFromSol(appName , sol){    var res;        $(sol.projects).each(function(key, proj){        if(proj.name == appName){            res = proj;            return res;        }    })        return res;}/** * @param {String} appname : le nom du projet * @param {Object} sol : l'objet solution * @return {Object} le projet */function appendFileToLogs(appName , sol , file){    var     project = getApplicationFromSol(appName, sol),    files = project.logFiles;        files.push(file);}function removeFileToLogs(appName , sol , file){    var     project = getApplicationFromSol(appName, sol),    files = project.logFiles;            for(var i = 0; i < files.length; ++i)        {            if(files[i].name == file)            {                files.splice(i, 1);            }        }    }function loadfiles(name_app){                 $(".administration-content").empty();                                                   var name_sol = $('.solution_selected').find('span').html();                                                var sol_selected = $('.solution-click').find('span').html();                                                  var sol ;                         if (sol_selected == null){                             sol = name_sol;                         }else{                                                       sol  = sol_selected;                           }                          var App = {                                 name : name_app,                                 sol_name :sol                                                              };                                                                                                           var  App = JSON.stringify(App);                                                                    Url =  '/Files';                                             $.ajax({                                            type: 'POST',                                    url         :   Url,                                    data        :   App,                                    async  : false,                                    contentType :   "text/plain",                                    success:function(data){                                        var  tables=JSON.parse(data);                                                                                var txt="";                                         var regName=new RegExp("[ ]+", "g");                                          var regDate=new RegExp("[T]+", "g");                                        for (var i=0;i<tables.files.length;i++){                                                                                     var  name = tables.files[i].name.split(regName)                                          var  date = tables.files[i].date.split(regDate)                                                                                      txt+=   '<div class = "file"><span style="margin-right:40px;"><a style="text-decoration:none;" href="#" onClick="OpenStudio(\''+tables.files[i].path+'\')" >'+name[0]+'</a></span><span style="margin-right:40px;" >'+date[0]+' '+date[1].substring(0, 5)+'</span><span class="tdcol"><button id="remove"  class="studio-icon-remove" value="'+tables.files[i].name+'"></button></span></div>';                                                                                     }                                                                                                                        txt = '<div class="portlet-content">'+txt+'</div>';                                                                                                                                                                     $(".administration-content").append(txt);                                                                            },                                        error :function(err) {                                                                               }                                       });        tabledroite();    }	function    tabledroite () {			//init structure		$('.studio-icon-remove').hide();				$('.administration-content .file')			.mouseenter(function(event) {				$(this).addClass('file-hover');				$(this).find('button').show();			})			.mouseleave(function(event) {				$(this).removeClass('file-hover');				$(this).find('button').hide();			});		}  function   OpenStudio(path){                                       // do something on click                                                                    var path_file =  path.replace(/\//g , "\\");                                                         if (typeof studio !== 'undefined') {                                   try{                                        studio.openFile(path_file);                              } catch (e) {                                                                }                             }                     }                      function trunc(txt){     var regName=new RegExp("[/]+", "g");    var arraydata;    var result = "" ;    var lenght = txt.length;    if( lenght > 30)        {            arraydata = txt.split(regName);             result = txt.substring(0,24)+'.../'+arraydata.pop();        }else{                        result = txt;                   }               return result;        }